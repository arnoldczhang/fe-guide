# 网络安全

## 目录
<details>
<summary>展开更多</summary>

* [`CSP`](#CSP)
* [`XSS`](#XSS)
* [`CSRF`](#XSS)

</details>

## 参考
- https://www.zhihu.com/question/26628342/answer/33572866
- [6种漏洞](https://mp.weixin.qq.com/s/Umd-HAbUsLBoxEOIrdZ8vg)
- [csrf防范](https://juejin.im/post/5bc009996fb9a05d0a055192)

## CSP

### 原理
- 在HTTP Header中声明一个随机字符串，在HTML中的JavaScript标签上带了nonce属性，nonce的值和Header指定的一致才会执行对应的JavaScript代码

### 具体操作
```js
// .html or template
<script nonce="aaaa" >alert('aaaa')</script>
<script nonce="bbbb" >alert('bbbb')</script>

// 方式一：koa
// app.js
app.user(async function(ctx) {
  ctx.set('Content-Security-Policy', "script-src 'nonce-aaaa'");
  // ...
});

// 方式二：nginx
// nginx.conf
location / {
  add_header Content-Security-Policy "script-src 'nonce-aaaa'";
}
```

### 参考
1. https://www.zhihu.com/question/21979782/answer/42920769
2. [xss](http://www.cnblogs.com/TankXiao/archive/2012/03/21/2337194.html)


## XSS
Cross-Site Scripting（跨站脚本攻击）

### 原理
- 攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行

### 注入方式
* 恶意内容以<script />注入HTML中内嵌的文本（input）
  - escape
* 标签的 href、src 等属性中，包含 javascript: jAvaScript: 等可执行代码
* onload、onerror、onclick 等事件中，注入不受控制代码
* background-image:url("javascript:..."); （新版本浏览器已经可以防范）
* css-expression （新版本浏览器已经可以防范）

### 分类
|   | 存储型 | 反射型 | DOM型 |
| -------- | -----: | :----: | :----: |
| 存储区 | 数据库 | URL | 数据库/url/前端存储 |
| 插入点 | HTML | HTML | js |

* 存储型
  - 输入框中提交恶意代码到数据库，日后访问的话，
    服务端可能会取出恶意代码返回客户端执行
  - 恶意代码会加载外部代码执行更复杂的逻辑
  - 比如坛发帖、商品评论、用户私信等
* 反射型
  - 构造特殊url（通常是个接口），包含恶意代码，服务端返回给客户端后执行
  - 比如网站搜索、跳转等
* DOM型
  - 构造特殊url，客户端接收、执行
  - 和反射型区别：DOM型是js执行，是前端漏洞，其他两种是服务端漏洞

### 防御
- 针对 HTML 属性、HTML 文字内容、HTML 注释、跳转链接、
  内联 JavaScript 字符串、内联 CSS 样式表等，做不同转义
- .textContent、.setAttribute()
- 避免内联事件绑定，改用addEventListener
- 避免eval、setTimeout、setInterval字符串方式调用
- CSP
  - 禁止外联脚本、外域提交
  - 禁止内联脚本、未授权脚本
- 输入内容长度控制
- 验证码（校验人为操作）
- http-only

### 学习
[练习题](http://prompt.ml)
[答案](https://github.com/cure53/XSSChallengeWiki/wiki/prompt.ml)

```js
function escape(input) {
  // warm up
  // script should be executed without user interaction
  return '<input type="text" value="' + input + '">';
}
document.body.innerHTML = escape('"><svg onload=console.log(1)>');
```

### 举例
1. github如何防止xss
在线编辑/查看，文件代码都会通过模板转成不同含义的标签（通过颜色可以看出），
不是完整的输入输出


## CSRF
- 跨站请求伪造（Cross-site request forgery）

### 防御
- 请求携带标识，与服务端session对比








