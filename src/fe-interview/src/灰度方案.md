# 灰度方案

## 方案

1. 按流量

2. 按userId分桶

3. 按特征标/用户属性分桶

4. 白名单

5. 组合策略

|     | 按流量                        | 按userId分桶                                 | 按特征标/用户属性分桶                  | 白名单                 | 组合策略                                                   |
| --- | -------------------------- | ----------------------------------------- | ---------------------------- | ------------------- | ------------------------------------------------------ |
| 方案  | 10% -> 25% -> 50% -> 100%  | 根据用户唯一标识（userId、设备id、sessionId）做哈希或取模运算分桶 | 按用户特定属性（会员等级、标签、地理特征）分桶      | 只允许特定用户访问新版本        | 1. 内测阶段：白名单<br/><br/>2. 小范围：按userId分桶<br/><br/>3. 按流量分 |
| 优点  | 简单，精确控制曝光比例                | 简单，同一用户多次访问都在一个分桶                         | 灵活，精确到特定群体，**abtest就是特征标分桶** | 简单（搞个cdn配置即可），风险极可控 | 灵活                                                     |
| 缺点  | 需要处理用户状态的一致性（比如特点活动+分享的场景） | 人数不精确、不平均                                 | 需要一套特征管理系统                   | 无法代表真实用户体验          |                                                        |

## 问题

### 为什么**按userId分桶**不平均？

userId的存储存在稀疏性，不连续，比如`userId % 100 < 10`，做为10%用户放量的标准，结果只会<=10%

## 注意项

1. 用户体验一致性

2. 浏览器缓存：灰度策略本身不可被当做缓存

3. 后端兼容性：新老接口都要在，也支持灰度

## 总结

1. **最简单快捷的**：按userId或流量灰度

2. **灵活性和精细控制**：按特征标/用户属性灰度

3. **最安全**：白名单

4. **大规模复杂场景**：组合策略
