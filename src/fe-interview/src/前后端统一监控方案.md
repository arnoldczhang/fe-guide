# 前后端统一监控方案

## 方案

- TraceId
- SessionId
- ActionId
- 错误指纹

|      | TraceId                                                               | SessionId                                            | ActionId                                                    | 错误指纹             |
| ---- | --------------------------------------------------------------------- | ---------------------------------------------------- | ----------------------------------------------------------- | ---------------- |
| 时效性  | 单次请求                                                                  | 30分钟-2小时                                             | 单次关键操作请求                                                    | 单次错误             |
| 生成方式 | 1. 前端生成TraceId，通过`x-trace-id`传给后端<br/><br/>2. 后端透传TraceId，在日志和监控数据中关联 | 1. 前端生成SessionId，所有行为（错误、性能、点击等交互）与后端请求通过SessionId关联 | 1. 前端在关键操作时生成唯一操作标记（ActionId），给后端<br/><br/>2. 后端记录到日志中做后续关联 | md5(error stack) |
| 优点   | 全链路追踪                                                                 | 时间段的聚合分析                                             | 关键操作归因                                                      | 高频错误归因           |
| 缺点   | 前后端都有改动                                                               | 无法精确到单次操作                                            | 属于自定义埋点，要手工埋；无法覆盖其他类型事件（比如静态资源异常）                           | 上下文缺失            |

---

## 分层

1. 数据采集层
2. 传输层
3. 存储层
4. 计算层
5. 应用层

### 1. 数据采集层

前后端sdk（前端sendBean、后端中间件）

### 2. 传输层

kafka统一接收数据，缓冲削峰

### 3. 存储层

clickhouse、物化视图

### 4. 计算层

实时计算 - flink
离线计算 - hive/spark

### 5. 应用层

可视化平台、告警系统、根因工具